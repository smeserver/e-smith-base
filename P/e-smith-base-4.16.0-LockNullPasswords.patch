diff -Nur -x '*.orig' -x '*.rej' e-smith-base-4.16.0/createlinks mezzanine_patched_e-smith-base-4.16.0/createlinks
--- e-smith-base-4.16.0/createlinks	2006-03-15 03:20:43.000000000 +1100
+++ mezzanine_patched_e-smith-base-4.16.0/createlinks	2006-04-07 11:39:27.923754268 +1000
@@ -357,6 +357,7 @@
 
 templates2events("/home/e-smith/ssl.pem/pem", $event);
 event_link("rmmod-bonding", $event, "10");
+event_link("user-lock-passwd", $event, "15");
 event_link("set-hostname", $event, "10");
 event_link("conf-modules", $event, "30");
 event_link("conf-startup", $event, "60");
diff -Nur -x '*.orig' -x '*.rej' e-smith-base-4.16.0/root/etc/e-smith/events/actions/user-lock-passwd mezzanine_patched_e-smith-base-4.16.0/root/etc/e-smith/events/actions/user-lock-passwd
--- e-smith-base-4.16.0/root/etc/e-smith/events/actions/user-lock-passwd	2005-11-21 15:28:05.000000000 +1100
+++ mezzanine_patched_e-smith-base-4.16.0/root/etc/e-smith/events/actions/user-lock-passwd	2006-04-07 11:38:45.420141640 +1000
@@ -1,7 +1,7 @@
 #!/usr/bin/perl -w
 
 #----------------------------------------------------------------------
-# copyright (C) 2001-2005 Mitel Networks Corporation
+# copyright (C) 2001-2006 Mitel Networks Corporation
 # 
 # This program is free software; you can redistribute it and/or modify
 # it under the terms of the GNU General Public License as published by
@@ -16,9 +16,6 @@
 # You should have received a copy of the GNU General Public License
 # along with this program; if not, write to the Free Software
 # Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307  USA
-# 
-# Technical support for this program is available from Mitel Networks 
-# Please visit our web site www.mitel.com/sme/ for details.
 #----------------------------------------------------------------------
 
 package esmith;
@@ -26,28 +23,66 @@
 use strict;
 use Errno;
 use esmith::AccountsDB;
+use IO::File;
+use English;
 
 my $a = esmith::AccountsDB->open or die "Could not open accounts db";
 
 my $event = $ARGV [0];
-my $userName = $ARGV [1];
-
-#------------------------------------------------------------
-# Lock the user account in all authentication databases
-#------------------------------------------------------------
-
-die "Username argument missing." unless defined ($userName);
-
-my $u = $a->get($userName) or die "No account record for user $userName";
 
-my $type = $u->prop('type');
-die "Account $userName is not a user account; lock user failed.\n"
-    unless ($type eq 'user');
+my @users_to_lock = bad_password_users();
 
-system("/usr/bin/passwd", "-l", $userName) == 0
-    or die "Error running /usr/bin/passwd command to lock account $userName";
-system("/usr/bin/smbpasswd", "-d", $userName) == 0
-    or die "Error running /usr/bin/smbpasswd command to lock account $userName";
-$u->set_prop('PasswordSet', 'no');
+defined $ARGV[1] && push @users_to_lock, $ARGV[1];
 
-exit (0);
+for my $user (@users_to_lock)
+{
+    lock_user($user);
+}
+
+exit 0;
+
+sub lock_user
+{
+    my ($userName) = @_;
+    #------------------------------------------------------------
+    # Lock the user account in all authentication databases
+    #------------------------------------------------------------
+
+    my $u = $a->get($userName) or die "No account record for user $userName";
+
+    my $type = $u->prop('type');
+    die "Account $userName is not a user account; lock user failed.\n"
+        unless ($type eq 'user');
+
+    system("/usr/bin/passwd", "-l", $userName) == 0
+        or die "Error running /usr/bin/passwd command to lock account $userName";
+    system("/usr/bin/smbpasswd", "-d", $userName) == 0
+        or die "Error running /usr/bin/smbpasswd command to lock account $userName";
+    $u->set_prop('PasswordSet', 'no');
+}
+
+sub bad_password_users
+{
+    my $smbpasswd = IO::File->new("/etc/samba/smbpasswd", '<')
+        or die "Can't open smbpasswd: $OS_ERROR\n";
+
+    my @users;
+
+    SMBPASSWD:
+    while (my $smb_entry = <$smbpasswd>)
+    {
+        my ($user, $uid, $lanman_hash, $nt_hash, @rest) 
+            = split /:/, $smb_entry;
+
+        if (   $lanman_hash eq "AAD3B435B51404EEAAD3B435B51404EE"
+            or $nt_hash     eq "31D6CFE0D16AE931B73C59D7E0C089C0"
+           )
+        {
+            push @users, $user;
+            next SMBPASSWD;
+        }
+    }
+
+    $smbpasswd->close;
+    return @users;
+}
