Index: e-smith-base/e-smith-base.spec
diff -u e-smith-base/root/etc/e-smith/events/actions/group-create-unix:1.5 e-smith-base/root/etc/e-smith/events/actions/group-create-unix:1.6
--- e-smith-base/root/etc/e-smith/events/actions/group-create-unix:1.5	Fri Apr  1 11:52:47 2005
+++ e-smith-base/root/etc/e-smith/events/actions/group-create-unix	Wed Jul 27 14:38:37 2005
@@ -55,7 +55,7 @@
 {
     use esmith::lockfile;
 
-    $lock = esmith::lockfile::LockFileOrWait("/home/e-smith/accounts");
+    $lock = esmith::lockfile::LockFileOrWait("/home/e-smith/db/accounts");
     $gid = $accounts->get_next_uid;
     $group->set_prop('Gid', $gid);
     unless ($group->prop('Uid'))
Index: e-smith-base/root/etc/e-smith/events/actions/user-create-unix
diff -u e-smith-base/root/etc/e-smith/events/actions/user-create-unix:1.9 e-smith-base/root/etc/e-smith/events/actions/user-create-unix:1.10
--- e-smith-base/root/etc/e-smith/events/actions/user-create-unix:1.9	Fri Apr  1 14:53:56 2005
+++ e-smith-base/root/etc/e-smith/events/actions/user-create-unix	Wed Jul 27 14:38:37 2005
@@ -52,7 +52,7 @@
 {
     use esmith::lockfile;
 
-    $lock = esmith::lockfile::LockFileOrWait("/home/e-smith/accounts");
+    $lock = esmith::lockfile::LockFileOrWait("/home/e-smith/db/accounts");
     $uid = $accounts->get_next_uid;
     $acct->set_prop('Uid', $uid);
 }
Index: e-smith-base/root/etc/e-smith/templates/etc/e-smith/pam/accounts.allow/00usedb
diff -u e-smith-base/root/etc/e-smith/templates/etc/e-smith/pam/accounts.allow/00usedb:1.1.1.1 e-smith-base/root/etc/e-smith/templates/etc/e-smith/pam/accounts.allow/00usedb:removed
--- e-smith-base/root/etc/e-smith/templates/etc/e-smith/pam/accounts.allow/00usedb:1.1.1.1	Fri Feb 15 14:31:21 2002
+++ e-smith-base/root/etc/e-smith/templates/etc/e-smith/pam/accounts.allow/00usedb	Wed Dec 31 19:00:00 1969
@@ -1,3 +0,0 @@
-{
-    use esmith::db;
-}
Index: e-smith-base/root/etc/e-smith/templates/etc/e-smith/pam/accounts.allow/20userAccounts
diff -u e-smith-base/root/etc/e-smith/templates/etc/e-smith/pam/accounts.allow/20userAccounts:1.1.1.1 e-smith-base/root/etc/e-smith/templates/etc/e-smith/pam/accounts.allow/20userAccounts:1.2
--- e-smith-base/root/etc/e-smith/templates/etc/e-smith/pam/accounts.allow/20userAccounts:1.1.1.1	Fri Feb 15 14:31:22 2002
+++ e-smith-base/root/etc/e-smith/templates/etc/e-smith/pam/accounts.allow/20userAccounts	Wed Jul 27 14:38:37 2005
@@ -1,7 +1,6 @@
 {
-    tie my %accounts, 'esmith::config', '/home/e-smith/accounts';
+    use esmith::AccountsDB;
+    my $adb = esmith::AccountsDB->open_ro();
 
-    $OUT = join("\n", grep { db_get_type(\%accounts, $_) eq 'user'
-                        && db_get_prop(\%accounts, $_, 'PasswordSet') eq 'yes'
-                    } keys %accounts);
+    $OUT = join "\n", map { $_->key; } grep { $_->prop('PasswordSet') eq 'yes' } $adb->users;
 }
Index: e-smith-base/root/etc/e-smith/templates/etc/e-smith/pam/accounts.deny/10passwordRequired
diff -u e-smith-base/root/etc/e-smith/templates/etc/e-smith/pam/accounts.deny/10passwordRequired:1.1.1.1 e-smith-base/root/etc/e-smith/templates/etc/e-smith/pam/accounts.deny/10passwordRequired:1.2
--- e-smith-base/root/etc/e-smith/templates/etc/e-smith/pam/accounts.deny/10passwordRequired:1.1.1.1	Fri Feb 15 14:31:22 2002
+++ e-smith-base/root/etc/e-smith/templates/etc/e-smith/pam/accounts.deny/10passwordRequired	Wed Jul 27 14:38:37 2005
@@ -1,30 +1,24 @@
 {
-    use esmith::db;
-
-    tie my %accounts, 'esmith::config', '/home/e-smith/accounts';
+    use esmith::AccountsDB;
+    my $adb = esmith::AccountsDB->open_ro();
 
     while ( my $name = getpwent )
     {
 	next if ($name eq "admin");
-
 	next if ($name eq "public") and ($ACCOUNTS_DENY_ALLOW_PUBLIC);
 
-	my $type = db_get_type(\%accounts, $name) || 'none';
+	my $a = $adb->get($name);
+	next unless defined $a;
 
+	my $type = $a->prop('type') || 'none';
 	if ( $type =~ /(user|ibay)/ )
 	{
-	    my $passwordSet = db_get_prop(\%accounts, $name, "PasswordSet") || 
-		'no';
-
+	    my $passwordSet = $a->prop('PasswordSet') || 'no';
 	    next if ($passwordSet eq "yes");
 
-	    my $ftpMode = db_get_prop(\%accounts, $name, "PublicAccess") ||
-		'none';
-
+	    my $ftpMode = $a->prop('PublicAccess') || 'none';
 	    next if ($ftpMode eq "local" or $ftpMode eq "global");
-
 	}
-
 	$OUT .= "$name\n";
     }
 }
Index: e-smith-base/root/etc/e-smith/templates/etc/e-smith/pam/users.allow/00usedb
diff -u e-smith-base/root/etc/e-smith/templates/etc/e-smith/pam/users.allow/00usedb:1.1.1.1 e-smith-base/root/etc/e-smith/templates/etc/e-smith/pam/users.allow/00usedb:removed
--- e-smith-base/root/etc/e-smith/templates/etc/e-smith/pam/users.allow/00usedb:1.1.1.1	Fri Feb 15 14:31:22 2002
+++ e-smith-base/root/etc/e-smith/templates/etc/e-smith/pam/users.allow/00usedb	Wed Dec 31 19:00:00 1969
@@ -1,3 +0,0 @@
-{
-    use esmith::db;
-}
Index: e-smith-base/root/etc/e-smith/templates/etc/e-smith/pam/users.allow/20userAccounts
diff -u e-smith-base/root/etc/e-smith/templates/etc/e-smith/pam/users.allow/20userAccounts:1.1.1.1 e-smith-base/root/etc/e-smith/templates/etc/e-smith/pam/users.allow/20userAccounts:1.2
--- e-smith-base/root/etc/e-smith/templates/etc/e-smith/pam/users.allow/20userAccounts:1.1.1.1	Fri Feb 15 14:31:22 2002
+++ e-smith-base/root/etc/e-smith/templates/etc/e-smith/pam/users.allow/20userAccounts	Wed Jul 27 14:38:37 2005
@@ -1,7 +1,6 @@
 {
-    tie my %accounts, 'esmith::config', '/home/e-smith/accounts';
+    use esmith::AccountsDB;
+    my $adb = esmith::AccountsDB->open_ro();
 
-    join("\n", grep { db_get_type(\%accounts, $_) eq 'user'
-                        && db_get_prop(\%accounts, $_, 'PasswordSet') eq 'yes'
-                    } keys %accounts);
+    $OUT = join "\n", map { $_->key; } grep { $_->prop('PasswordSet') eq 'yes' } $adb->users;
 }
Index: e-smith-base/root/etc/e-smith/templates/etc/httpd/admin-conf/httpd.conf/01localAccessString
diff -u e-smith-base/root/etc/e-smith/templates/etc/httpd/admin-conf/httpd.conf/01localAccessString:1.2 e-smith-base/root/etc/e-smith/templates/etc/httpd/admin-conf/httpd.conf/01localAccessString:1.3
--- e-smith-base/root/etc/e-smith/templates/etc/httpd/admin-conf/httpd.conf/01localAccessString:1.2	Mon Jun  2 18:42:05 2003
+++ e-smith-base/root/etc/e-smith/templates/etc/httpd/admin-conf/httpd.conf/01localAccessString	Wed Jul 27 14:38:37 2005
@@ -1,26 +1,17 @@
 {
-    use esmith::util;
-
-    #------------------------------------------------------------
-    # Compute "localAccess" string for use in template below.
-    #------------------------------------------------------------
-    my %networks;
-    tie %networks, 'esmith::config', '/home/e-smith/networks';
-
-    my @access = esmith::util::computeLocalAccessSpec( $LocalIP, 
-			$LocalNetmask, \%networks, 'private');
-
-    $localAccess = "@access";
-
-    my $validFrom = ${"httpd-admin"}{"ValidFrom"} || 'none';
-
-    $validFrom =~ s/,/ /g;
-    unless ($validFrom eq 'none')
-    {
-        $localAccess .= " $validFrom";
-    }
+    #---------------------------------------------------------------------
+    # Grab ValidFrom access list property of httpd-admin
+    # SSL enabled virtual hosts should only allow access from IP's in
+    # this list, as well as local networks.
+    #---------------------------------------------------------------------
+    use esmith::NetworksDB;
+
+    my $ndb = esmith::NetworksDB->open_ro();
+
+    $localAccess = $ndb->local_access_spec();
+    my $validFrom = ${'httpd-admin'}{'ValidFrom'} || 'none';
+    $localAccess .= " $validFrom" unless ($validFrom eq 'none');
     $localAccess =~ s:/255.255.255.255::g;
 
     "";
 }
-
Index: e-smith-base/root/etc/e-smith/tests/10e-smith-base/configuration.conf
diff -u e-smith-base/root/etc/e-smith/tests/10e-smith-base/configuration.conf:1.14 e-smith-base/root/etc/e-smith/tests/10e-smith-base/configuration.conf:1.15
--- e-smith-base/root/etc/e-smith/tests/10e-smith-base/configuration.conf:1.14	Thu Mar 10 15:57:23 2005
+++ e-smith-base/root/etc/e-smith/tests/10e-smith-base/configuration.conf	Wed Jul 27 14:38:37 2005
@@ -33,7 +33,7 @@
 LocalNetmask=255.255.255.0
 MinUid=5000
 PasswordSet=yes
-PreviousConfiguration=/home/e-smith/configuration.previous
+PreviousConfiguration=/home/e-smith/db/configuration.previous
 SMTPSmartHost=
 SambaDomainMaster=no
 SambaServerName=pretz
Index: e-smith-base/root/etc/rc.d/init.d/e-smith-service
diff -u e-smith-base/root/etc/rc.d/init.d/e-smith-service:1.7 e-smith-base/root/etc/rc.d/init.d/e-smith-service:1.8
--- e-smith-base/root/etc/rc.d/init.d/e-smith-service:1.7	Wed Aug  4 12:34:20 2004
+++ e-smith-base/root/etc/rc.d/init.d/e-smith-service	Wed Jul 27 14:38:37 2005
@@ -48,7 +48,7 @@
     INITSCRIPT=${S_INITSCRIPT}
 fi
 
-STATUS=$( /sbin/e-smith/db /home/e-smith/configuration getprop ${SERVICE} status )
+STATUS=$( /sbin/e-smith/db configuration getprop ${SERVICE} status )
 
 case $1 in
     *start)
Index: e-smith-base/root/sbin/e-smith/console
diff -u e-smith-base/root/sbin/e-smith/console:1.157 e-smith-base/root/sbin/e-smith/console:1.158
--- e-smith-base/root/sbin/e-smith/console:1.157	Wed Jul 27 14:26:44 2005
+++ e-smith-base/root/sbin/e-smith/console	Wed Jul 27 14:38:37 2005
@@ -65,7 +65,7 @@
 
         return undef if ($self->EXISTS($key) and $self->FETCH($key) eq $value);
 
-        if (($self->filename eq '/home/e-smith/configuration')
+        if (($self->filename eq 'configuration')
             && ($key ne 'UnsavedChanges')) {
             $self->SUPER::STORE('UnsavedChanges', 'yes');
         }
Index: e-smith-base/root/sbin/e-smith/init_config
diff -u e-smith-base/root/sbin/e-smith/init_config:1.2 e-smith-base/root/sbin/e-smith/init_config:1.3
--- e-smith-base/root/sbin/e-smith/init_config:1.2	Tue Jun  7 11:32:57 2005
+++ e-smith-base/root/sbin/e-smith/init_config	Wed Jul 27 14:38:37 2005
@@ -65,7 +65,7 @@
 
         return undef if ($self->EXISTS($key) and $self->FETCH($key) eq $value);
 
-        if (($self->filename eq '/home/e-smith/configuration')
+        if (($self->filename eq 'configuration')
             && ($key ne 'UnsavedChanges')) {
             $self->SUPER::STORE('UnsavedChanges', 'yes');
         }
