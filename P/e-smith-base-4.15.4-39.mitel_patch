Index: e-smith-base/createlinks
diff -u e-smith-base/createlinks:1.116 e-smith-base/createlinks:1.117
--- e-smith-base/createlinks:1.116	Tue Sep  6 17:42:26 2005
+++ e-smith-base/createlinks	Thu Sep 22 10:25:42 2005
@@ -57,6 +57,7 @@
 # conf-networking
 
 foreach (qw(
+    /etc/sysconfig/network-scripts/ifcfg-bond0
     /etc/sysconfig/network-scripts/ifcfg-eth0
     /etc/sysconfig/network-scripts/ifcfg-eth0.4094
     /etc/sysconfig/network-scripts/ifcfg-eth1
Index: e-smith-base/e-smith-base.spec
diff -u e-smith-base/root/etc/e-smith/db/configuration/migrate/10interfaces:1.6 e-smith-base/root/etc/e-smith/db/configuration/migrate/10interfaces:1.7
--- e-smith-base/root/etc/e-smith/db/configuration/migrate/10interfaces:1.6	Mon May  9 17:11:00 2005
+++ e-smith-base/root/etc/e-smith/db/configuration/migrate/10interfaces	Thu Sep 22 10:25:42 2005
@@ -1,6 +1,6 @@
 {
 #----------------------------------------------------------------------
-# copyright (C) 1999-2003 Mitel Networks Corporation
+# copyright (C) 1999-2005 Mitel Networks Corporation
 #
 # This program is free software; you can redistribute it and/or modify
 # it under the terms of the GNU General Public License as published by
@@ -16,8 +16,6 @@
 # along with this program; if not, write to the Free Software
 # Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307  USA
 #
-# Technical support for this program is available from Mitel Networks
-# Please visit our web site www.mitel.com/sme/ for details.
 #----------------------------------------------------------------------
 # Migrate old config db singletons into "interface" specifications:
 #
@@ -49,12 +47,14 @@
                  $DB->new_record("dhcpcd", { type => 'service' } );
 
     my $mode = $DB->get_value("SystemMode") || "servergateway";
+    my $bonding = $internal->prop('NICBonding') || "disabled";
 
     my %int_props =
     (
         type => "interface",
-        Name => ($mode eq "serveronly") ? "eth0" :
-		($ethernet_assign eq 'swapped') ? "eth1" : "eth0",
+        Name => ($mode eq "serveronly") ? 
+		    ($bonding eq "enabled") ? "bond0" : "eth0" :
+			($ethernet_assign eq 'swapped') ? "eth1" : "eth0",
         Configuration => 'static',
         Driver => $DB->get_value("EthernetDriver1"),
         IPAddress => $DB->get_value("LocalIP"),
Index: e-smith-base/root/etc/e-smith/events/actions/user-modify-unix
diff -u e-smith-base/root/etc/e-smith/events/actions/user-modify-unix:1.6 e-smith-base/root/etc/e-smith/events/actions/user-modify-unix:1.7
--- e-smith-base/root/etc/e-smith/events/actions/user-modify-unix:1.6	Tue Aug 23 11:09:34 2005
+++ e-smith-base/root/etc/e-smith/events/actions/user-modify-unix	Thu Sep 22 10:25:42 2005
@@ -52,22 +52,33 @@
 	unless ( ($userName eq 'admin') or ($type eq 'user') );
 
     setpwent;
-    my $shell = (getpwnam($userName))[8];
+    my ($comment, $shell) = (getpwnam($userName))[5,8];
     endpwent;
-    $shell = $u->prop('Shell')
+    my $new_shell = $u->prop('Shell')
 		|| (($shell eq "/bin/sshell") ? "/usr/bin/rssh" : $shell);
 
     #------------------------------------------------------------
-    # Modify user's first name and last name, and shell,
+    # Modify user's shell, if required, in /etc/passwd using "usermod"
+    #------------------------------------------------------------
+    unless ($shell eq $new_shell)
+    {
+	system("/usr/sbin/usermod", '-s', "$shell", $userName) == 0
+	    or die "Failed to modify shell of account $userName.\n";
+    }
+
+    #------------------------------------------------------------
+    # Modify user's first name and last name if required,
     # in /etc/passwd using "usermod"
     #------------------------------------------------------------
     my $first = $u->prop('FirstName') || "";
     my $last = $u->prop('LastName') || "";
+    my $new_comment = "$first $last";
 
-    system("/usr/sbin/usermod", "-c", "$first $last",
-	    '-s', "$shell",
-	    $userName) == 0
-	or die "Failed to modify account $userName.\n";
+    unless ($comment eq $new_comment)
+    {
+	system("/usr/sbin/usermod", "-c", "$first $last", $userName) == 0
+	    or die "Failed to modify comment of account $userName.\n";
+    }
 }
 
 exit (0);
Index: e-smith-base/root/etc/e-smith/templates/etc/modprobe.conf/10bonding
diff -u /dev/null e-smith-base/root/etc/e-smith/templates/etc/modprobe.conf/10bonding:1.1
--- /dev/null	Thu Sep 22 10:48:15 2005
+++ e-smith-base/root/etc/e-smith/templates/etc/modprobe.conf/10bonding	Thu Sep 22 10:25:42 2005
@@ -0,0 +1,14 @@
+{
+    foreach my $line
+	(
+	    "alias bond0 bonding",
+	    "options bond0 miimon=200",
+	)
+    {
+	unless (exists $lines{$line})
+	{
+	    push @lines, $line;
+	}
+    }
+    "";
+}
Index: e-smith-base/root/etc/e-smith/templates/etc/sysconfig/network-scripts/ifcfg-ethX/05TYPE
diff -u /dev/null e-smith-base/root/etc/e-smith/templates/etc/sysconfig/network-scripts/ifcfg-ethX/05TYPE:1.1
--- /dev/null	Thu Sep 22 10:48:16 2005
+++ e-smith-base/root/etc/e-smith/templates/etc/sysconfig/network-scripts/ifcfg-ethX/05TYPE	Thu Sep 22 10:25:42 2005
@@ -0,0 +1,3 @@
+{
+    return "TYPE=Ethernet";
+}
Index: e-smith-base/root/etc/e-smith/templates/etc/sysconfig/network-scripts/ifcfg-ethX/60IPV6
diff -u /dev/null e-smith-base/root/etc/e-smith/templates/etc/sysconfig/network-scripts/ifcfg-ethX/60IPV6:1.1
--- /dev/null	Thu Sep 22 10:48:16 2005
+++ e-smith-base/root/etc/e-smith/templates/etc/sysconfig/network-scripts/ifcfg-ethX/60IPV6	Thu Sep 22 10:25:42 2005
@@ -0,0 +1,3 @@
+{
+    return "IPV6INIT=no";
+}
Index: e-smith-base/root/etc/e-smith/templates/etc/sysconfig/network-scripts/ifcfg-ethX/70bonding
diff -u /dev/null e-smith-base/root/etc/e-smith/templates/etc/sysconfig/network-scripts/ifcfg-ethX/70bonding:1.1
--- /dev/null	Thu Sep 22 10:48:16 2005
+++ e-smith-base/root/etc/e-smith/templates/etc/sysconfig/network-scripts/ifcfg-ethX/70bonding	Thu Sep 22 10:25:43 2005
@@ -0,0 +1,9 @@
+{
+    $OUT = "";
+    return unless ($InternalInterface{Name} eq "bond0");
+    if ($THIS_DEVICE =~ /eth[01]/)
+    {
+	$OUT .= "MASTER=bond0\n";
+	$OUT .= "SLAVE=yes";
+    }
+}
Index: e-smith-base/root/etc/e-smith/templates.metadata/etc/sysconfig/network-scripts/ifcfg-bond0
diff -u /dev/null e-smith-base/root/etc/e-smith/templates.metadata/etc/sysconfig/network-scripts/ifcfg-bond0:1.1
--- /dev/null	Thu Sep 22 10:48:17 2005
+++ e-smith-base/root/etc/e-smith/templates.metadata/etc/sysconfig/network-scripts/ifcfg-bond0	Thu Sep 22 10:25:43 2005
@@ -0,0 +1,3 @@
+TEMPLATE_PATH="/etc/sysconfig/network-scripts/ifcfg-ethX"
+OUTPUT_FILENAME="/etc/sysconfig/network-scripts/ifcfg-bond0"
+MORE_DATA={ THIS_DEVICE => "bond0" }
